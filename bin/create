#!/usr/bin/env node
var nopt = require('nopt'),
	path = require('path'),
	fs = require('fs'),
	opts = nopt({
		"old": path,
		"new": path,
		"out": path,
		"blocksize": Number,
		"verify": Boolean,
		"verbose": Number
	});

	if( !opts.old || !opts['new'] ){
		console.log('--old [filename] --new [filename]\nОпционально:\n\t--out [filename] Файл, в который нужно записать патч\n'+
					'\t--blocksize [Number] Минимальный размер блока для вставки\n\t--verify Выполнить проверку патча после создания'+
					'\t--verbose [0,1,2] Не писать ничего, Писать время, Писать всю информацию');
		return;
	}
	if( opts.verbose ){
		opts.verbose > 2 && (opts.verbose = 2);
		opts.verbose < 0 && (opts.verbose = 0);
	}
	var strA = fs.readFileSync(opts.old, 'utf-8'),
		strB = fs.readFileSync(opts['new'], 'utf-8'),
		patch = require('../lib/create.js')(strA, strB, opts.blocksize, opts.verbose);
	if( opts.verify ){
		var applied = require('../lib/apply.js')(strA, patch, opts.verbose);
		var verifyStartTime = new Date();
		console.log('Патч ' + (applied === strB? 'хороший':'плохой'));
		opts.verbose && console.log('Проверил за ' + (new Date() - verifyStartTime) + 'мс');
	}
	if( opts.out ){
		fs.writeFileSync(opts.out, JSON.stringify(patch), 'utf-8');
	}else{
		console.log(JSON.stringify(patch));
	}
